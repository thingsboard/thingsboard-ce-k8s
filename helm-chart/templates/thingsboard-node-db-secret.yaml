apiVersion: v1
kind: Secret
metadata:
  name: {{ include "thingsboard.fullname" . }}-node-db-secret
  labels:
    {{- include "thingsboard.labels" . | nindent 4 }}
type: Opaque
data:
  {{- if and .Values.postgres.enabled (not .Values.postgres.existingSecretName) }}
  # if local postgres enabled, and not provided existing secrets
  {{ $fullname :=  include "thingsboard.fullname" . }}
  {{ $port := .Values.postgres.service.port | toString }}
  SPRING_DATASOURCE_URL: {{ printf "jdbc:postgresql://%s-postgres.%s.svc.cluster.local:%s/thingsboard" $fullname .Release.Namespace $port | b64enc }}
  SPRING_DATASOURCE_USERNAME: {{ .Values.postgres.username | b64enc }}
  SPRING_DATASOURCE_PASSWORD: {{ .Values.postgres.password | b64enc }}
  {{- else if and (not .Values.postgres.enabled ) (not .Values.externalPostgres.existingSecretName) }}
  # if external postgres configured, and not provided existing secrets
  SPRING_DATASOURCE_URL: {{ .Values.externalPostgres.postgresUrl | b64enc }}
  SPRING_DATASOURCE_USERNAME: {{ .Values.externalPostgres.username | b64enc }}
  SPRING_DATASOURCE_PASSWORD: {{ .Values.externalPostgres.password | b64enc }}
  {{- end }}

  {{- if and .Values.externalCassandra.enabled (not .Values.cassandra.enabled) }}
  CASSANDRA_USERNAME: {{ .Values.externalCassandra.username }}
  CASSANDRA_PASSWORD: {{ .Values.externalCassandra.password }}
  {{- end }}